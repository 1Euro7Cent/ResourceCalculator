<html>
	<head>
		<style type="text/css">
			body {
				font-family: sans-serif;
				line-height: 2em;
				background:  #EFEFEF;
				margin: 0;
				padding: 0;
			}


.search_bar {
	margin: 10px;
	max-width: 800px;
	margin-left: auto;
	margin-right: auto;
}

.search_label_wrapper {
	float:left;
	padding: 5px 10px;
	border: 2px solid #8b90a1;
	border-right: 0;
	background: #D8D9ED;
	border-radius: 5px 0 0 5px;
	line-height: initial;
}
.search_label {
}

.search_box_wrapper {
	display: block;
	overflow: hidden;
}
.search_box {
	width: 100%;
	box-sizing:border-box;
	padding: 5px;
	margin: 0;
	color: #000;
	font-family: sans-serif;
	background-color: #fff;
	border: none;
	border-top: 2px solid #8b90a1;
	border-bottom: 2px solid #8b90a1;
	border-right: 2px solid #8b90a1;
	font-size: 1em;
	border-radius: 0 5px 5px 0;
}





			.resource_list {
				margin-left: auto;
				margin-right: auto;
				max-width:  800px;
				position: relative;
				min-height: {{total_height}}px;
			}

			.resource {
				background: #d8e8db;
				display: flex;
				border-radius: 5px;
				border: 2px solid #9bb998;
				min-height: 50px;
				position: absolute;
				width: 100%;
				box-sizing: border-box;
				transition: top .2s;
			}
			.resource_anim_out{
				transition: margin-top .2s;
				margin-top: 0;
			}

			.ordering_drag {
				margin-left: 10px;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				font-size: 1.5em;
				cursor: grab;
				display: none; /* TODO: implement drag and drop eventually */;
			}
			.ordering_index {
				display: inline-flex;
				align-items: center;
				margin-left: 10px;
			}
			.resource_label {
				display: inline-flex;
				align-items: center;
				margin-left: 10px;
			}
			.resource_name {
				display: inline-flex;
				align-items: center;
				flex-grow: 1;
				margin-left: 10px;
			}
			/*@media only screen and (min-device-width : 320px) and (max-device-width : 480px) {*/
			@media only screen and (max-width : 480px) {
				.resource_label {
					display: none;
				}
			}

			.edit {
				display: inline-flex;
				cursor: pointer;
				padding-left: 10px;
				padding-right: 10px;
				align-items: center;
				border-radius: 3px;
				transition: background-color 0.1s linear, color 0.1s linear;
			}
			.edit:hover {
				background: #A2D7AB;
			}
			

			input {
				font-size: 1em;
			}
/*			input[type=text] {
				border: none;
				font-size: 1em;
			}*/
			.item_name {
				border: none;
				width: 100%;
				/*height: 40px;*/
				padding: 5px 10px;

				padding-left: 10px;
			}
/*			.resource:hover {
				background: #AAA;
			}
*/			.breakdown {
				background-color: #ccc;
				/*padding-top: 10px;*/
				overflow: hidden;
				/*border: 1px solid black;*/
				/*background: #BBB;*/
			}

			.zeroheight {
/*				height: 0;
				padding: 0;
				margin: 0;*/
			}

			.drag_order {
				display: inline-block;
			}

			.ordering_value {
				display: inline-block;
				width: 35px;
				text-align: center;
				background:  inherit;
				border: none;

			}
			.ordering_value:focus {
				background: #FFF;
			}
			.recipe{
				margin-left: 10px;
				border-left: 10px solid #e1a579;
				/*padding: 10px;*/
				margin-bottom: 10px;
				padding-left: 10px;
				/*background: #;*/
			}
			.recipe_requirement {
				margin-left: 10px;
			}


			.integermod_button {
				display:  inline-block;
				width: 1.5em;
				background: #DDD;
				line-height: 1.5em;
				text-align: center;
				z-index: -1;	
			}

			.requirement_list {
				/*display: inline-block;*/
				border-left: 10px solid #54bd52;

			}

		</style>

		<datalist id="recipetypelist">
			<option value="Crafting">
		</datalist>
		<datalist id="itemnamelist">
		</datalist>

		<div style="display: none">
			<div id="resource" class="resource">
				<div class="ordering_drag">&#8597;</div>
				<div class="ordering_index"><input id="ordering_index" class="ordering_value" type="text" /></div>
				<div class="resource_label"><label for="name">Name:</label></div>
				<div class="resource_name"><input id="name" type="text" class="item_name" /></div>
				<div class="edit">edit</div>
			</div>

				<!-- <div class="save hidden">save</div> -->
				<div id="breakdown" class="breakdown zeroheight">
					Recipes: <div id="recipe_list"></div>
					<!-- Custom Stack Sizes: <span id="custom_stack_sizes"></span> -->
				</div>


			<div id="recipe" class="recipe">
				Type: <input id="recipe_type" type="text" list="recipetypelist" /><br>
				Output: <div class="integermod_button">-</div><input id="recipe_output_quantity" class="ordering_value" type="text"><div class="integermod_button">+</div><br>
				Ingredients:<div id="requirement_list" class=requirement_list></div>
			</div>
			<div id="recipe_requirement" class="recipe_requirement">
				<input id="requirement_name" type="text">
				<div class="integermod_button">-</div><input id="requirement_value" class="ordering_value" type="text"><div class="integermod_button">+</div>
			</div>
		</div>

	</head>
	<body>
		
		<div class="search_bar">
			<div class="search_label_wrapper">
				<label class="search_label" for="item_filter">Filter:</label>
			</div>
			<span class="search_box_wrapper">
			<input type="text" class="search_box" id="item_filter"></span>
		</div>


		<div id="resource_list" class="resource_list"></div>
	</body>
	<script>{{ resource_list_json }}</script>
	<script>

		let breakdown_elem = document.getElementById("breakdown");
		function open_resources(name, elem) {
			console.log("clicked", name, elem);
			elem.querySelector("#breakdown").classList.toggle("zeroheight");
		}



		// function filter_items() {
		// 	// var search_string = $("#item_filter").val().toLowerCase();
		// 	let search_string = document.getElementById("item_filter").value.toLowerCase();
		// 	// var hide_unused = $("#unused_hide_checkbox").prop("checked");

		// 	// Loop through each item
		// 	for (let resource in )

		// 	$("#content_field").find(".desired_item").each(function() {
		// 		var item_name = $(this).find("input").attr("aria-label").toLowerCase();
		// 		var item_count = $(this).find(".desired_item_count").val();

		// 		// If the search string does not match hide the item
		// 		// If the item count is not greater than 0 and hide unused is true hide
		// 		if (item_name.indexOf(search_string) === -1 || !(item_count > 0 || !hide_unused)) {
		// 			$(this).hide();
		// 		}
		// 		else {
		// 			$(this).show();
		// 		}
		// 	});
		// }
		// $("#item_filter").bind("propertychange change click keyup input paste", function(){
		// 	filter_items();
		// });

		const element_height = {{element_height}};
		const buffer_element_count = {{buffer_element_count}};


		////////////////////////////////////////////////////////////////////////
		// Speed optimization where only the visible rows are added to the DOM
		// this is a useful speedup for both inital page load and also page
		// use. This concept was suggusted by Google Page Insights linking to
		// https://web.dev/dom-size/ which suggusted modules for Vue and React.
		// Neither of which are used on this site and instead this basic js
		// function was written instead.
		//
		// TODO: A slight optimization might want to be considered where a box
		// that appears in both the old and the new element list is re-used.
		// This is not a speed optimization nessasarily but it will prevent the
		// text input from being blured due to the old text input being
		// destroyed and replaced with a new text input.
		////////////////////////////////////////////////////////////////////////
		let active_resource_elements = [];
		function redraw_resouce_elements(animate_out_index=undefined, animate_in_index=undefined) {
			for (let i in active_resource_elements) {
				let active_resource_element = active_resource_elements[i];
				active_resource_element.parentNode.removeChild(active_resource_element);
			}
			active_resource_elements = [];

			let resource_elem = document.getElementById("resource");
			let resource_list_elem = document.getElementById("resource_list");
			let recipe_elem = document.getElementById("recipe");
			let recipe_requirement_elem = document.getElementById("recipe_requirement");

			let ordering_index = 1;
			
			let window_height = window.innerHeight 
								|| document.documentElement.clientHeight
								|| document.body.clientHeight;
			 
			let start_index = Math.max(Math.floor((document.body.scrollTop - resource_list_elem.offsetTop) / element_height) - buffer_element_count, 0);
			let end_index =   Math.min(Math.floor((document.body.scrollTop - resource_list_elem.offsetTop + window_height) / element_height) + buffer_element_count, resource_list_json.resources.length)

			// item_name.indexOf(search_string) === -1

			for (let i = start_index; i < end_index; i++) {
				(function(key) {
					let name = resource_list_json.resources[key].name;
					
					let cloned_resource_elem = resource_elem.cloneNode(true);
					cloned_resource_elem.querySelector("#name").value = name;

					cloned_resource_elem.style.top = element_height * key;

					// If receiving animation indices then animate anything between them
					if (key >= animate_out_index && key < animate_in_index) {
						cloned_resource_elem.style.top = (key+1) * element_height + "px";
						setTimeout(function(){cloned_resource_elem.style.top = key * element_height + "px";},1);
					}
					else if (key <= animate_out_index && key > animate_in_index) {
						cloned_resource_elem.style.top = (key-1) * element_height + "px";
						setTimeout(function(){cloned_resource_elem.style.top = key * element_height + "px";},1);
					}
					else if (key == animate_in_index){
						cloned_resource_elem.style.top = animate_out_index * element_height + "px";
						setTimeout(function(){cloned_resource_elem.style.top = key * element_height + "px";},1);
					}

					let ordering_index_elem = cloned_resource_elem.querySelector("#ordering_index");
					ordering_index_elem.value = key+1;
					ordering_index_elem.addEventListener("change", function(e,a,b,c) {
						let parsed = parseInt(this.value);
						if (!isNaN(parsed)) {
							if (parsed < 1) {
								parsed = 1;
							}
							if (parsed > resource_list_json.resources.length) {
								parsed = resource_list_json.resources.length
							}

							// Move Item to New Location
							resource_list_json.resources.splice(parsed-1, 0, resource_list_json.resources.splice(key, 1)[0]);
						}
						redraw_resouce_elements(key, parsed-1);
					});
					ordering_index_elem.addEventListener("focus", function(a,b,c) {
						this.setSelectionRange(0, this.value.length)
					})

					cloned_resource_elem.array_index = key;
					resource_list_elem.appendChild(cloned_resource_elem);
					active_resource_elements.push(cloned_resource_elem);
				})(i)
			}
		}


		document.addEventListener('scroll', function(e) {
			// TOOD: A speed optimization might want to be considered where if the
			// scroll has not exceeded one object height since the last render then
			// the objects are not re-rendered.
			redraw_resouce_elements();
		});
		window.addEventListener('resize', function(e) {
			redraw_resouce_elements();
		});
		redraw_resouce_elements();


				// let recipe_list_elem = cloned_resource_elem.querySelector("#recipe_list")
				// ordering_index += 1;
				// cloned_resource_elem.addEventListener("click", function() {
				// 	open_resources(key, cloned_resource_elem);
				// })
				// // console.log(resource_list_json.resources[key]);
				// for (let recipe_index in resource_list_json.resources[key].recipes) {
				// 	let recipe = resource_list_json.resources[key].recipes[recipe_index];
				// 	// console.log(recipe);
				// 	let cloned_recipe_elem = recipe_elem.cloneNode(true);
				// 	cloned_recipe_elem.querySelector("#recipe_type").value = recipe.recipe_type;
				// 	cloned_recipe_elem.querySelector("#recipe_output_quantity").value = recipe.output;
				// 	let requirement_list = cloned_recipe_elem.querySelector("#requirement_list")
				// 	for (let requirement_name in recipe.requirements){
				// 		let cloned_requirement_elem = recipe_requirement_elem.cloneNode(true);

				// 		cloned_requirement_elem.querySelector("#requirement_value").value = recipe.requirements[requirement_name];
				// 		cloned_requirement_elem.querySelector("#requirement_name").value = requirement_name;

				// 		requirement_list.appendChild(cloned_requirement_elem);

				// 	}
				// 	recipe_list_elem.appendChild(cloned_recipe_elem);
				// }



				// // Only Generate the elements that we need to
				// window_height = window.innerHeight 
				// 				|| document.documentElement.clientHeight
				// 				|| document.body.clientHeight;
				// if (cloned_resource_elem.offsetTop > window_height + document.body.scrollTop) {
				// 	return true;
				// }
				// return false;
	</script>
</html>