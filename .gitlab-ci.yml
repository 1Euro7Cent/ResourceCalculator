stages:
  # - build
  # - test
  - deploy

deploy-prod:
  image: docker:git
  services:
    - docker:dind
  stage: deploy
  script:
    # # install the required applications
    # - apt-get update
    # - apt-get install -qq -y python-pip
    # - pip install awscli --ignore-installed six
    # # - apt-get install -qq -y docker

    # - mkdir ~/.aws
    # - "echo -e '[default]'\naws_access_key_id=$AWS_ACCESS_KEY_ID\naws_secret_access_key=$AWS_SECRET_ACCESS_KEY"


    # Build and upload the image
    # - aws ecr get-login --region us-east-1
    -docker login -u AWS -p $DOCKER_REGISTRY_PASSWORD -e none $DOCKER_REGISTRY_URL
    - docker build -t resourcecalculator .
    - docker tag resourcecalculator:latest 879234386562.dkr.ecr.us-east-1.amazonaws.com/resourcecalculator:latest
    - docker push 879234386562.dkr.ecr.us-east-1.amazonaws.com/resourcecalculator:latest
  only:
    - master



    # # Install ssh-agent if not already installed, it is required by Docker.
    # # (change apt-get to yum if you use a CentOS-based image)
    # - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'

    # # Run ssh-agent (inside the build environment)
    # - eval $(ssh-agent -s)

    # # Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
    # - ssh-add <(echo "$SSH_PRIVATE_KEY")

    # # For Docker builds disable host key checking. Be aware that by adding that
    # # you are suspectible to man-in-the-middle attacks.
    # # WARNING: Use this only with the Docker executor, if you use it with shell
    # # you will overwrite your user's SSH config.
    # - mkdir -p ~/.ssh
    # - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    # - ssh $PROD_USER@$PROD_HOST ls
    # - ssh $PROD_USER@$PROD_HOST tree
    # - scp -r . $PROD_USER@$PROD_HOST:/home/$PROD_USER/resourcecalculator.com/
    # - ssh $PROD_USER@$PROD_HOST "cd resourcecalculator.com; bundle install"